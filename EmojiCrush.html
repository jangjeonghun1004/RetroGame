<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Retro Emoji Crush DX</title>
    <!-- Íµ¨Í∏Ä Ìè∞Ìä∏ -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Í∏∞Î≥∏ Ïä§ÌÉÄÏùº (Ïú†ÏßÄ) --- */
        * {
            margin: 0; padding: 0; box-sizing: border-box;
            user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #2a1a3e;
            color: #0f0;
            font-family: 'Press Start 2P', cursive;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; height: 100dvh; overflow: hidden;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }

        .console-body {
            background-color: #e0e0e0;
            width: 100%; max-width: 420px;
            height: calc(100dvh - 10px); max-height: 850px;
            border-radius: 15px; padding: 10px; padding-bottom: 5px;
            display: flex; flex-direction: column;
            box-shadow: 0 0 0 2px #d0d0d0, 0 10px 20px rgba(0,0,0,0.5), inset 0 -5px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .screen-bezel {
            background-color: #111;
            border-radius: 8px; padding: 8px;
            flex: 1; min-height: 40%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
            margin-bottom: 8px; position: relative; overflow: hidden;
        }

        #game-container {
            position: relative; width: 100%; height: 100%;
            background-color: #000; border: 2px solid #333;
            overflow: hidden; border-radius: 4px;
        }

        canvas {
            display: block; width: 100%; height: 100%;
            background-color: #2b1d36;
        }

        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 10;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; pointer-events: auto; overflow: hidden;
        }

        .screen-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.85); text-align: center; padding: 10px;
        }
        .screen-ui.active { display: flex; }

        h1 { font-size: 16px; margin-bottom: 10px; color: #ff0; text-shadow: 2px 2px #f00; line-height: 1.4; }
        p { font-size: 9px; color: #fff; margin-bottom: 6px; line-height: 1.4; }

        button {
            background: transparent; color: #0f0; font-family: 'Press Start 2P', cursive;
            font-size: 9px; padding: 8px 10px; border: 2px solid #0f0; cursor: pointer;
            margin-top: 6px; text-transform: uppercase;
        }
        button:hover { background: #0f0; color: #000; }
        button.blink { animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .stat-item { background: rgba(255,255,255,0.1); border: 1px solid #fff; padding: 5px; margin: 5px; }

        .controls-area {
            flex: 0 0 auto; display: grid; grid-template-columns: 1fr 1fr;
            align-items: center; gap: 2px; padding: 5px 2px; max-height: 40vh;
        }

        .d-pad-container { position: relative; width: 140px; height: 140px; justify-self: center; align-self: center; }
        .d-pad { position: relative; width: 100%; height: 100%; }
        .d-pad div { position: absolute; background: #333; border-radius: 6px; box-shadow: inset 1px 1px 2px rgba(255,255,255,0.2), 2px 2px 5px rgba(0,0,0,0.3); }
        .d-pad-h { top: 46px; left: 0; width: 140px; height: 48px; z-index: 1; }
        .d-pad-v { top: 0; left: 46px; width: 48px; height: 140px; z-index: 1; }
        .d-pad-center { top: 46px; left: 46px; width: 48px; height: 48px; background: radial-gradient(circle at 30% 30%, #444, #222); z-index: 2; border-radius: 50%; pointer-events: none; }
        
        .d-btn { position: absolute; z-index: 10; opacity: 0; cursor: pointer; }
        .btn-up { top: -15px; left: 30px; width: 80px; height: 75px; }
        .btn-down { bottom: -15px; left: 30px; width: 80px; height: 75px; }
        .btn-left { top: 30px; left: -15px; width: 75px; height: 80px; }
        .btn-right { top: 30px; right: -15px; width: 75px; height: 80px; }

        .action-buttons { position: relative; width: 120px; height: 120px; justify-self: center; align-self: center; transform: rotate(-15deg); }
        .abxy-btn {
            position: absolute; width: 34px; height: 34px; border-radius: 50%; background: #333;
            color: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center;
            font-family: 'Roboto', sans-serif; font-weight: bold; font-size: 14px;
            box-shadow: 0 3px 0 #111, 0 5px 5px rgba(0,0,0,0.3); cursor: pointer;
        }
        .abxy-btn:active { transform: translateY(3px); box-shadow: 0 0 0 #111; }
        .btn-x { top: 5px; left: 43px; color: #40a0ff; }
        .btn-y { top: 43px; left: 5px; color: #40ff40; font-size: 8px; }
        .btn-b { top: 43px; right: 5px; color: #ffd040; font-size: 8px; }
        .btn-a { bottom: 5px; left: 43px; color: #ff4040; }
        
        .help-text {
            position: absolute; bottom: 5px; width: 100%; text-align: center;
            font-size: 8px; color: #666; pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="console-body">
        <div class="screen-bezel">
            <div id="game-container">
                <canvas id="gameCanvas"></canvas>
                <div class="scanlines"></div>
                
                <div id="ui-layer">
                    <!-- ÏãúÏûë ÌôîÎ©¥ -->
                    <div id="screen-start" class="screen-ui active">
                        <h1>EMOJI<br>CRUSH DX</h1>
                        <p style="color:#aaa; font-size:8px;">EXTREME EDITION</p>
                        <div class="stat-item">
                            <p>HIGH SCORE</p>
                            <p id="start-highscore" style="color:#ff0; font-size:12px;">0</p>
                        </div>
                        <button id="start-btn" class="blink">INSERT COIN</button>
                        <p class="help-text">D-PAD: MOVE / A: SELECT</p>
                    </div>

                    <!-- Í≤åÏûÑ Ïò§Î≤Ñ -->
                    <div id="screen-gameover" class="screen-ui">
                        <h1 style="color:#f00;">TIME OVER</h1>
                        <p>FINAL SCORE</p>
                        <p id="go-score" style="color:#ff0; font-size:16px; margin:10px;">0</p>
                        <button id="retry-btn">TRY AGAIN</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls-area">
            <div class="d-pad-container">
                <div class="d-pad">
                    <div class="d-pad-h"></div><div class="d-pad-v"></div><div class="d-pad-center"></div>
                    <div class="d-btn btn-up" id="btn-up"></div>
                    <div class="d-btn btn-down" id="btn-down"></div>
                    <div class="d-btn btn-left" id="btn-left"></div>
                    <div class="d-btn btn-right" id="btn-right"></div>
                </div>
            </div>
            <div class="action-buttons">
                <div class="abxy-btn btn-x">X</div>
                <div class="abxy-btn btn-y" id="btn-y">RST</div>
                <div class="abxy-btn btn-b" id="btn-b">BACK</div>
                <div class="abxy-btn btn-a" id="btn-a">A</div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('game-container');
        
        // UI
        const screenStart = document.getElementById('screen-start');
        const screenGameOver = document.getElementById('screen-gameover');
        const startHighScoreDisplay = document.getElementById('start-highscore');
        const goScoreDisplay = document.getElementById('go-score');
        const startBtn = document.getElementById('start-btn');
        const retryBtn = document.getElementById('retry-btn');

        let highScore = parseInt(localStorage.getItem('emojiCrush_highScore')) || 0;
        startHighScoreDisplay.innerText = highScore;

        function showScreen(screen) {
            screenStart.classList.remove('active');
            screenGameOver.classList.remove('active');
            if(screen) screen.classList.add('active');
        }

        // --- Ïò§ÎîîÏò§ (Í∏∞Ï°¥ Ïú†ÏßÄ) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'move') {
                osc.type = 'square'; 
                osc.frequency.setValueAtTime(200, now);
                gain.gain.setValueAtTime(0.05, now);
                osc.start(now); osc.stop(now + 0.05);
            } else if (type === 'select') {
                osc.type = 'triangle'; 
                osc.frequency.setValueAtTime(440, now);
                osc.frequency.linearRampToValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'match') {
                osc.type = 'square'; 
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(800, now + 0.15);
                gain.gain.setValueAtTime(0.15, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'levelup') { // Î†àÎ≤®ÏóÖ ÏÇ¨Ïö¥Îìú
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(220, now);
                osc.frequency.linearRampToValueAtTime(880, now + 0.4);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            } else if (type === 'bad') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                osc.start(now); osc.stop(now + 0.2);
            }
        }

        // --- Í≤åÏûÑ Î°úÏßÅ Î∞è Î≥ÄÏàò ---
        
        // 1. ÌÖåÎßà Ï†ïÏùò (Î†àÎ≤®Î≥Ñ Ïù¥Î™®ÏßÄ ÏÑ∏Ìä∏)
        const THEMES = [
            {
                name: "FRUITS",
                emojis: ['üçé', 'üçá', 'üçä', 'üíé', 'üç™', 'ü••'],
                colors: ['#ff4444', '#aa44ff', '#ffaa00', '#00ffff', '#d2691e', '#ffffff']
            },
            {
                name: "NATURE",
                emojis: ['üåµ', 'üå≤', 'üçÑ', 'üåª', 'üî•', 'üíß'],
                colors: ['#00ff00', '#228b22', '#ff0000', '#ffd700', '#ff4500', '#00bfff']
            },
            {
                name: "SPACE",
                emojis: ['üëΩ', 'üöÄ', '‚≠ê', 'üåô', 'ü™ê', '‚òÑÔ∏è'],
                colors: ['#00ff00', '#ffffff', '#ffff00', '#ffffaa', '#ffa500', '#00ffff']
            },
            {
                name: "ANIMALS",
                emojis: ['üê∂', 'üê±', 'üê≠', 'ü¶ä', 'üê∏', 'üê∑'],
                colors: ['#d2691e', '#ffa500', '#808080', '#ff4500', '#00ff00', '#ffc0cb']
            },
            {
                name: "FACES",
                emojis: ['üòÄ', 'üòé', 'üòç', 'ü§î', 'üò±', 'ü§°'],
                colors: ['#ffff00', '#333333', '#ff0000', '#ffff00', '#0000ff', '#ff0000']
            }
        ];

        const COLS = 7;
        const ROWS = 8;
        let board = [];
        let tileSize = 40;
        let startX = 0;
        let startY = 0;

        let score = 0;
        let level = 1;
        let timeLeft = 60;
        let gameRunning = false;
        let isProcessing = false;
        let cursor = { x: 3, y: 4 };
        let selected = null;

        // ÌòÑÏû¨ ÌÖåÎßà ÏÉÅÌÉú
        let currentThemeIndex = 0;
        let currentEmojis = [];
        let currentColors = [];

        // Ìö®Í≥º Í¥ÄÎ†® Î≥ÄÏàò
        let shake = 0;
        let particles = [];
        let floatTexts = [];
        let timerInterval = null;

        // --- ÌååÌã∞ÌÅ¥ ÏãúÏä§ÌÖú ÌÅ¥ÎûòÏä§ ---
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 4 + 2; 
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 1.0;
                this.decay = Math.random() * 0.03 + 0.02; 
                this.color = color;
                this.size = Math.random() * 5 + 3; 
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.25; 
                this.life -= this.decay;
                this.size *= 0.95; 
            }
            draw(ctx) {
                if(this.life <= 0) return;
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.fillRect(this.x, this.y, this.size, this.size); 
                ctx.globalAlpha = 1.0;
            }
        }

        class FloatText {
            constructor(x, y, text, color, size = 10) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.color = color;
                this.life = 1.0;
                this.vy = -1.5; 
                this.size = size;
            }
            update() {
                this.y += this.vy;
                this.life -= 0.015;
            }
            draw(ctx) {
                if(this.life <= 0) return;
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.font = `${this.size}px "Press Start 2P"`;
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.strokeText(this.text, this.x, this.y);
                ctx.fillText(this.text, this.x, this.y);
                ctx.globalAlpha = 1.0;
            }
        }

        function resizeCanvas() {
            canvas.width = gameContainer.clientWidth;
            canvas.height = gameContainer.clientHeight;
            const availableHeight = canvas.height - 60;
            const sizeByWidth = Math.floor((canvas.width - 20) / COLS);
            const sizeByHeight = Math.floor((availableHeight - 10) / ROWS);
            tileSize = Math.min(sizeByWidth, sizeByHeight);
            startX = Math.floor((canvas.width - (COLS * tileSize)) / 2);
            startY = 60 + Math.floor((availableHeight - (ROWS * tileSize)) / 2);
        }

        window.addEventListener('resize', resizeCanvas);

        function setTheme(index) {
            currentThemeIndex = index % THEMES.length;
            currentEmojis = THEMES[currentThemeIndex].emojis;
            currentColors = THEMES[currentThemeIndex].colors;
        }

        function initBoard() {
            board = [];
            for(let y=0; y<ROWS; y++) {
                let row = [];
                for(let x=0; x<COLS; x++) {
                    let type;
                    do { type = Math.floor(Math.random() * currentEmojis.length); } 
                    while ((x >= 2 && row[x-1] === type && row[x-2] === type) ||
                           (y >= 2 && board[y-1][x] === type && board[y-2][x] === type));
                    row.push(type);
                }
                board.push(row);
            }
        }

        function draw() {
            ctx.save();
            if (shake > 0) {
                const dx = (Math.random() - 0.5) * shake;
                const dy = (Math.random() - 0.5) * shake;
                ctx.translate(dx, dy);
                shake *= 0.9; 
                if(shake < 0.5) shake = 0;
            }

            ctx.fillStyle = '#2b1d36';
            ctx.fillRect(-10, -10, canvas.width+20, canvas.height+20); 

            // ÏÉÅÎã® UI
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(-10, 0, canvas.width+20, 50);
            ctx.fillStyle = '#fff';
            ctx.font = '10px "Press Start 2P"';
            
            ctx.textAlign = 'left';
            ctx.fillText(`LV.${level} ${THEMES[currentThemeIndex].name}`, 10, 20);
            ctx.fillStyle = '#ff0';
            ctx.fillText(`${score}`, 10, 38);
            
            ctx.textAlign = 'right';
            ctx.fillStyle = timeLeft < 10 ? '#f00' : '#0f0';
            ctx.fillText(`TIME: ${Math.floor(timeLeft)}`, canvas.width - 10, 32);

            // Î≥¥Îìú
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = `${tileSize * 0.7}px sans-serif`;

            for(let y=0; y<ROWS; y++) {
                for(let x=0; x<COLS; x++) {
                    const posX = startX + x * tileSize;
                    const posY = startY + y * tileSize;

                    ctx.strokeStyle = '#444';
                    ctx.strokeRect(posX, posY, tileSize, tileSize);

                    const type = board[y][x];
                    if (type !== -1) {
                        ctx.fillText(currentEmojis[type], posX + tileSize/2, posY + tileSize/2 + 2);
                    }
                }
            }

            if (selected) {
                const sX = startX + selected.x * tileSize;
                const sY = startY + selected.y * tileSize;
                ctx.strokeStyle = '#ff0';
                ctx.lineWidth = 3;
                ctx.strokeRect(sX+2, sY+2, tileSize-4, tileSize-4);
            }

            if (gameRunning && !isProcessing) {
                const cX = startX + cursor.x * tileSize;
                const cY = startY + cursor.y * tileSize;
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.setLineDash([4, 2]);
                ctx.strokeRect(cX, cY, tileSize, tileSize);
                ctx.setLineDash([]);
            }

            particles.forEach(p => p.draw(ctx));
            floatTexts.forEach(t => t.draw(ctx));

            ctx.restore(); 
        }

        function findMatches() {
            let matches = [];
            for(let y=0; y<ROWS; y++) {
                for(let x=0; x<COLS-2; x++) {
                    let type = board[y][x];
                    if(type === -1) continue;
                    if(board[y][x+1] === type && board[y][x+2] === type) {
                        matches.push({x:x, y:y}, {x:x+1, y:y}, {x:x+2, y:y});
                        let k = x+3;
                        while(k < COLS && board[y][k] === type) { matches.push({x:k, y:y}); k++; }
                    }
                }
            }
            for(let x=0; x<COLS; x++) {
                for(let y=0; y<ROWS-2; y++) {
                    let type = board[y][x];
                    if(type === -1) continue;
                    if(board[y+1][x] === type && board[y+2][x] === type) {
                        matches.push({x:x, y:y}, {x:x, y:y+1}, {x:x, y:y+2});
                        let k = y+3;
                        while(k < ROWS && board[k][x] === type) { matches.push({x:x, y:k}); k++; }
                    }
                }
            }
            return matches;
        }

        async function levelUp() {
            isProcessing = true;
            // ÌÉÄÏù¥Î®∏ ÏùºÏãú Ï†ïÏßÄ Ìö®Í≥º (Ïã§Ï†ú Ï†ïÏßÄÎäî ÏïÑÎãò)
            
            playSound('levelup');
            
            // ÌÖçÏä§Ìä∏ Ìö®Í≥º
            floatTexts.push(new FloatText(canvas.width/2, canvas.height/2, "LEVEL UP!", "#ffff00", 24));
            floatTexts.push(new FloatText(canvas.width/2, canvas.height/2 + 30, "+10 SEC", "#00ff00", 12));

            timeLeft += 10; // ÏãúÍ∞Ñ Î≥¥ÎÑàÏä§
            if(timeLeft > 60) timeLeft = 60;

            level++;
            shake = 20; // Í∞ïÌïú ÌùîÎì§Î¶º

            // Ï†ÑÏ≤¥ Ìè≠Î∞ú Ìö®Í≥º
            for(let y=0; y<ROWS; y++) {
                for(let x=0; x<COLS; x++) {
                    const type = board[y][x];
                    if(type !== -1) {
                        const cx = startX + x * tileSize + tileSize/2;
                        const cy = startY + y * tileSize + tileSize/2;
                        const color = currentColors[type] || '#fff';
                        for(let i=0; i<5; i++) { // Í∞Å ÏÖÄÎßàÎã§ ÌååÌã∞ÌÅ¥ ÏÉùÏÑ±
                            particles.push(new Particle(cx, cy, color));
                        }
                        board[y][x] = -1; // Î≥¥Îìú ÎπÑÏö∞Í∏∞
                    }
                }
            }
            
            draw();
            await wait(1000); // Ìè≠Î∞ú Í∞êÏÉÅ Î∞è ÎåÄÍ∏∞

            // Îã§Ïùå ÌÖåÎßà ÏÑ§Ï†ï
            setTheme(currentThemeIndex + 1);
            
            // ÏÉà Î≥¥Îìú Ï±ÑÏö∞Í∏∞ (Îß§Ïπò ÏóÜÏù¥)
            initBoard();
            
            // Îì±Ïû• Ìö®Í≥º (ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥)
            draw();
            await wait(500);

            isProcessing = false;
        }

        async function processBoard() {
            isProcessing = true;
            let loop = true;

            // Î†àÎ≤®ÏóÖ Ï°∞Í±¥ ÌôïÏù∏ (Ïòà: Î†àÎ≤® * 1000Ï†ê)
            const nextLevelScore = level * 1000;

            while(loop) {
                const matches = findMatches();
                if(matches.length === 0) { loop = false; break; }

                const uniqueMatches = matches.filter((v,i,a)=>a.findIndex(t=>(t.x===v.x && t.y===v.y))===i);
                
                score += uniqueMatches.length * 10;
                
                const timeBonus = uniqueMatches.length * 0.5;
                timeLeft += timeBonus;
                if(timeLeft > 60) timeLeft = 60; 

                shake = 8 + uniqueMatches.length; 
                playSound('match');

                uniqueMatches.forEach(p => {
                    const cx = startX + p.x * tileSize + tileSize/2;
                    const cy = startY + p.y * tileSize + tileSize/2;
                    const type = board[p.y][p.x];
                    const color = currentColors[type] || '#fff';
                    
                    for(let i=0; i<12; i++) {
                        particles.push(new Particle(cx, cy, color));
                    }
                    board[p.y][p.x] = -1;
                });

                floatTexts.push(new FloatText(
                    canvas.width/2, 
                    startY - 20, 
                    `+${timeBonus.toFixed(1)}s`, 
                    '#0f0'
                ));

                draw();
                await wait(250); 

                for(let x=0; x<COLS; x++) {
                    for(let y=ROWS-1; y>=0; y--) {
                        if(board[y][x] === -1) {
                            for(let k=y-1; k>=0; k--) {
                                if(board[k][x] !== -1) {
                                    board[y][x] = board[k][x];
                                    board[k][x] = -1;
                                    break;
                                }
                            }
                        }
                    }
                }
                draw();
                await wait(100);

                for(let y=0; y<ROWS; y++) {
                    for(let x=0; x<COLS; x++) {
                        if(board[y][x] === -1) {
                            board[y][x] = Math.floor(Math.random() * currentEmojis.length);
                        }
                    }
                }
                draw();
                await wait(200);
            }

            // Î™®Îì† Îß§Ïπò Ï≤òÎ¶¨ ÌõÑ Î†àÎ≤®ÏóÖ Ï≤¥ÌÅ¨
            if (score >= nextLevelScore) {
                await levelUp();
            }

            isProcessing = false;
        }

        function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        async function swap(x1, y1, x2, y2) {
            let temp = board[y1][x1];
            board[y1][x1] = board[y2][x2];
            board[y2][x2] = temp;
            draw();

            const matches = findMatches();
            if (matches.length > 0) {
                selected = null;
                await processBoard();
            } else {
                playSound('bad');
                shake = 3; 
                await wait(200);
                temp = board[y1][x1];
                board[y1][x1] = board[y2][x2];
                board[y2][x2] = temp;
                selected = null;
                draw();
            }
        }

        function update(time) {
            if (gameRunning) {
                particles.forEach(p => p.update());
                particles = particles.filter(p => p.life > 0);

                floatTexts.forEach(t => t.update());
                floatTexts = floatTexts.filter(t => t.life > 0);

                draw();
                requestAnimationFrame(update);
            }
        }

        function startGame() {
            initAudio();
            showScreen(null);
            
            score = 0;
            level = 1;
            timeLeft = 60;
            isProcessing = false;
            selected = null;
            cursor = { x: Math.floor(COLS/2), y: Math.floor(ROWS/2) };
            particles = [];
            floatTexts = [];
            shake = 0;

            resizeCanvas();
            
            // Ï¥àÍ∏∞ ÌÖåÎßà ÏÑ§Ï†ï
            setTheme(0);
            initBoard();
            
            gameRunning = true;
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(!gameRunning) return;
                timeLeft -= 0.1; 
                if(timeLeft <= 0) gameOver();
            }, 100);

            processBoard(); // Ï¥àÍ∏∞ Î≥¥Îìú Ï≤¥ÌÅ¨
            update();
        }

        function gameOver() {
            gameRunning = false;
            clearInterval(timerInterval);
            if(score > highScore) {
                highScore = score;
                localStorage.setItem('emojiCrush_highScore', highScore);
            }
            goScoreDisplay.innerText = score;
            startHighScoreDisplay.innerText = highScore;
            showScreen(screenGameOver);
        }

        function handleInput(key) {
            if (!gameRunning || isProcessing) return;

            if (key === 'up') { if(cursor.y > 0) { cursor.y--; playSound('move'); } }
            else if (key === 'down') { if(cursor.y < ROWS - 1) { cursor.y++; playSound('move'); } }
            else if (key === 'left') { if(cursor.x > 0) { cursor.x--; playSound('move'); } }
            else if (key === 'right') { if(cursor.x < COLS - 1) { cursor.x++; playSound('move'); } }
            else if (key === 'a') {
                playSound('select');
                if (selected) {
                    const dx = Math.abs(cursor.x - selected.x);
                    const dy = Math.abs(cursor.y - selected.y);
                    if (dx + dy === 1) { swap(selected.x, selected.y, cursor.x, cursor.y); }
                    else {
                        if(cursor.x === selected.x && cursor.y === selected.y) selected = null;
                        else selected = { ...cursor };
                    }
                } else { selected = { ...cursor }; }
            }
        }

        document.addEventListener('keydown', (e) => {
            if (screenStart.classList.contains('active') || screenGameOver.classList.contains('active')) {
                if (e.key === 'Enter' || e.key === ' ' || e.key.toLowerCase() === 'a') startGame();
                return;
            }
            switch(e.key) {
                case 'ArrowUp': handleInput('up'); break;
                case 'ArrowDown': handleInput('down'); break;
                case 'ArrowLeft': handleInput('left'); break;
                case 'ArrowRight': handleInput('right'); break;
                case 'a': case 'A': case 'z': case 'Z': case ' ': case 'Enter': handleInput('a'); break;
            }
        });

        const bindBtn = (id, key) => {
            const btn = document.getElementById(id);
            if(!btn) return;
            const action = (e) => {
                e.preventDefault();
                if(!gameRunning && (key==='a' || key==='start')) startGame();
                else handleInput(key);
            };
            btn.addEventListener('touchstart', action, {passive:false});
            btn.addEventListener('mousedown', action);
        };

        bindBtn('btn-up', 'up');
        bindBtn('btn-down', 'down');
        bindBtn('btn-left', 'left');
        bindBtn('btn-right', 'right');
        bindBtn('btn-a', 'a');
        bindBtn('btn-b', 'a');
        
        startBtn.addEventListener('click', startGame);
        retryBtn.addEventListener('click', startGame);

        window.addEventListener('load', resizeCanvas);
    </script>
</body>
</html>
